<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JWW to DXF Converter</title>
</head>
<body>
    <h1>JWW to DXF Converter</h1>
    <input type="file" id="fileInput" accept=".jww">
    <button id="convertBtn" disabled>DXFに変換</button>
    <pre id="output"></pre>

    <!-- Go WASM support script (必須) -->
    <script src="wasm_exec.js"></script>
    <script>
        const go = new Go();
        
        // WASMモジュールをロード
        WebAssembly.instantiateStreaming(fetch("jww.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
                console.log("WASM loaded! Available functions:", 
                    "jwwParse, jwwToDxf, jwwToDxfString");
                document.getElementById('convertBtn').disabled = false;
            })
            .catch((err) => {
                console.error("WASM load failed:", err);
            });

        // ファイル選択処理
        let selectedFile = null;
        document.getElementById('fileInput').addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
        });

        // 変換処理
        document.getElementById('convertBtn').addEventListener('click', async () => {
            if (!selectedFile) {
                alert('JWWファイルを選択してください');
                return;
            }

            // ファイルをUint8Arrayとして読み込み
            const arrayBuffer = await selectedFile.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            // WASMの関数を呼び出し
            const result = jwwToDxfString(uint8Array);
            
            if (result.ok) {
                // 成功：DXF文字列を表示/ダウンロード
                document.getElementById('output').textContent = result.data;
                
                // DXFファイルとしてダウンロード
                const blob = new Blob([result.data], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name.replace('.jww', '.dxf');
                a.click();
            } else {
                // エラー
                document.getElementById('output').textContent = 
                    'Error: ' + result.error;
            }
        });
    </script>
</body>
</html>
