name: Publish GitHub Pages via PR

on:
  push:
    branches:
      - main
    paths:
      - "wasm/**"
      - "Makefile"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/gh-pages.yml"
      - "dxf/**"
      - "jww/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: "pages-pr"
  cancel-in-progress: true

jobs:
  build-and-propose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build WebAssembly assets
        run: make dist

      - name: Archive build output
        run: cp -r dist ../pages-dist

      - name: Switch to gh-pages base tree
        run: |
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git switch --force-create gh-pages-work origin/gh-pages
          else
            git switch --orphan gh-pages-work
          fi

      - name: Prepare gh-pages branch content
        run: |
          shopt -s dotglob
          for path in *; do
            if [ "$path" != ".git" ]; then
              rm -rf "$path"
            fi
          done
          cp -a ../pages-dist/. .
          touch .nojekyll
          cat <<'README' > README.md
          # GitHub Pages artifacts
          
          このブランチはGitHub Pagesの公開用成果物のみを含みます。
          mainブランチの更新時に自動生成されるdistディレクトリの内容を配置しています。
          README

      - name: Create pull request to update gh-pages
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update GitHub Pages content"
          title: "Update GitHub Pages content"
          body: |
            Automated PR to refresh the GitHub Pages branch with the latest build from main.
          base: gh-pages
          branch: update/gh-pages
          delete-branch: true
